<?phpif (!defined('BASEPATH'))    exit('No direct script access allowed');class Messageboard extends MX_Controller {    function __construct() {        parent::__construct();        if (!$this->user_auth->is_logged_in()) {            redirect($this->config->item('base_url') . 'users/login');        }        $main_module = 'messageboard';        $access_arr = array(            'messageboard/index' => array('add'),            'messageboard/view_messages' => array('view'),            'messageboard/delete' => array('delete'),            'messageboard/getMessageboard' => "no_restriction",            'messageboard/send_message' => "no_restriction",            'messageboard/get_member_messages' => "no_restriction",            'messageboard/view_chat' => "no_restriction",            'messageboard/get_messageboard' => "no_restriction",            'messageboard/view_member_messages' => array('view'),            'messageboard/get_member_type' => "no_restriction",            'messageboard/send_message_to_admin' => "no_restriction"        );        if (!$this->user_auth->is_permission_allowed($access_arr, $main_module)) {            //redirect($this->config->item('base_url'));        }        $this->load->model('messageboard/messageboard_model');        //$this->template->write_view('session_msg', 'users/session_msg');    }    function index() {        $this->template->write_view('content', 'messageboard/messageboard_index');        $this->template->render();    }    function getMessageboard() {        $searchQuery = $this->input->post('query');        $searchString = "";        if (!(empty($searchQuery['generalSearch'])) && $searchQuery['generalSearch'] != "") {            $searchString = $searchQuery['generalSearch'];        }        $query = $this->input->post('query');        $forYearFrom = "";        $forYearTo = "";        if (isset($query['forYearFrom'])) {            $forYearFrom = $query['forYearFrom'];        }        if (isset($query["forYearTo"])) {            $forYearTo = $query["forYearTo"];        }        $this_member_id = $this->user_auth->get_user_id();        $this_member_type_id = $this->user_auth->get_member_type_id();        if ($this_member_type_id) {            $this_member_type_id = $this->user_auth->get_member_type_id();        } else {            $this_member_type_id = 0;        }        // echo "member id" . $this_member_type_id;        //exit;        $data['data'] = $this->messageboard_model->get_all_messageboard($searchString, $forYearFrom, $forYearTo, $this_member_id, $this_member_type_id);        $total_records = count($data['data']);        $pages = ceil($total_records / 10);        $data['meta'] = array(            "page" => 1,            "pages" => $pages,            "perpage" => -1,            "total" => $total_records,            "sort" => "asc",            "field" => "id"        );        echo json_encode($data);    }    function send_message() {        $caption = $this->input->post("caption");        $message_content = $this->input->post("message_content");        $has_confirmation = $this->input->post("has_confirmation");        $receiver_type = $this->input->post("receiver_type");        $created_by = $this->user_auth->get_user_id();        $created_date = date("Y-m-d H:i:s");        $member_type = 0;        $member_id = 0;        if ($receiver_type == "1") {            $member_type = $this->input->post("member_type");        } else if ($receiver_type == "2") {            $member_id = $this->input->post("member_id");        }        $data = array(            'caption' => $caption,            'message' => $message_content,            'member_type_id' => $member_type,            'member_id' => $member_id,            'receiver_type' => $receiver_type,            'has_confirmation' => $has_confirmation,            'created_by' => $created_by,            'created_date' => $created_date        );        $messageboard_id = $this->messageboard_model->insert($data);        $response = array();        if ($messageboard_id) {            $response['status'] = "success";            if ($receiver_type == "1") {                $all_member_id_by_type = $this->messageboard_model->get_all_members_by_type($member_type, $created_by);                if (is_array($all_member_id_by_type) && !empty($all_member_id_by_type)) {                    $response['member_count'] = count($all_member_id_by_type);                    foreach ($all_member_id_by_type as $member) {                        $data_chat_message = array(                            'message_id' => $messageboard_id,                            'sender_id' => $created_by,                            'receiver_id' => $member['id'],                            'acceptance_status' => 0,                            'view_status' => 0,                            'is_source_message' => 1,                            'created_date' => $created_date                        );                        $message_received_status = $this->messageboard_model->insert_chat_messages($data_chat_message);                        //echo $member['id'];//                        $data_message_received = array(//                            'member_id' => $member['id'],//                            'message_id' => $messageboard_id,//                            'acceptance_status' => 0,//                            'view_status' => 0,//                            'created_date' => $created_date//                        );//                        $message_received_status = $this->messageboard_model->insert_message_received($data_message_received);                    }                } else {                    $response['member_count'] = "0";                }            } else if ($receiver_type == "2") {                $memberdetails = $this->messageboard_model->get_user_by_id($member_id);                if (is_array($memberdetails) && !empty($memberdetails)) {                    $response['member_count'] = count($memberdetails);                    foreach ($memberdetails as $member) {                        $data_chat_message = array(                            'message_id' => $messageboard_id,                            'sender_id' => $created_by,                            'receiver_id' => $member['id'],                            'acceptance_status' => 0,                            'view_status' => 0,                            'is_source_message' => 1,                            'created_date' => $created_date                        );                        $message_received_status = $this->messageboard_model->insert_chat_messages($data_chat_message);                        //echo $member['id'];//                        $data_message_received = array(//                            'member_id' => $member['id'],//                            'message_id' => $messageboard_id,//                            'acceptance_status' => 0,//                            'view_status' => 0,//                            'created_date' => $created_date//                        );//                        $message_received_status = $this->messageboard_model->insert_message_received($data_message_received);                    }                } else {                    $response['member_count'] = "0";                }            } else if ($receiver_type == "3") {                $memberdetails = $this->messageboard_model->get_all_members($created_by);                if (is_array($memberdetails) && !empty($memberdetails)) {                    $response['member_count'] = count($memberdetails);                    foreach ($memberdetails as $member) {                        $data_chat_message = array(                            'message_id' => $messageboard_id,                            'sender_id' => $created_by,                            'receiver_id' => $member['id'],                            'acceptance_status' => 0,                            'view_status' => 0,                            'is_source_message' => 1,                            'created_date' => $created_date                        );                        $message_received_status = $this->messageboard_model->insert_chat_messages($data_chat_message);                        //echo $member['id'];//                        $data_message_received = array(//                            'member_id' => $member['id'],//                            'message_id' => $messageboard_id,//                            'acceptance_status' => 0,//                            'view_status' => 0,//                            'created_date' => $created_date//                        );//                        $message_received_status = $this->messageboard_model->insert_message_received($data_message_received);                    }                } else {                    $response['member_count'] = "0";                }            }            $update_total_count = array(                'total_count' => $response['member_count']            );            $update_message_total_count = $this->messageboard_model->update_messageboard($update_total_count, $messageboard_id);        } else {            $response['status'] = "failed";        }        echo json_encode($response);    }    function view_messages($id) {        $data_msg_notify['new_message'] = $this->user_auth->get_new_message($id);//        echo '<pre>';//        print_r($data_msg_notify);//        exit;        $this->template->write_view('popup', 'users/messageboard_notify', $data_msg_notify);        $this->template->write_view('content', 'messageboard/view_messages');        $this->template->render();    }    function get_member_messages($messageboard_id) {        $data['messageboard'] = $this->messageboard_model->get_messageboard_by_id($messageboard_id);        $this_member_id = $this->user_auth->get_user_id();        //$msg_data = $this->messageboard_model->get_chat_history($messageboard_id, $this_member_id, $data['messageboard'][0]['created_by']);        if ($data['messageboard'][0]['created_by'] == $this_member_id) {            $data['view_messages'] = $this->messageboard_model->get_messages_of_created_member($this_member_id, $messageboard_id);        } else {            $data['view_messages'] = $this->messageboard_model->get_messages_of_received_member($this_member_id, $messageboard_id);        }        //$data['view_messages'] = $this->messageboard_model->get_messages_of_created_member($this_member_id, $messageboard_id);        echo json_encode($data);    }    function update_view_status_all($messageboard_id) {        //$data['messageboard'] = $this->messageboard_model->get_messageboard_by_id($messageboard_id);        $this_member_id = $this->user_auth->get_user_id();        $update = $this->messageboard_model->update_view_of_created_member($this_member_id, $messageboard_id);        if ($update) {            $data['result'] = "success";        } else {            $data['result'] = "failed";        }        echo json_encode($data);    }    function view_chat($message_received_id) {        $data['message_received_status'] = $this->messageboard_model->get_message_received_status_by_id($message_received_id);        $message_id = $data['message_received_status'][0]['message_id'];        $member_id = $data['message_received_status'][0]['member_id'];        $data['chat_history'] = $this->messageboard_model->get_chat($message_id, $member_id);        $data['users'] = $this->messageboard_model->get_user_by_id($member_id);        echo json_encode($data);    }    function get_messageboard($messageboard_id) {        $data['messageboard'] = $this->messageboard_model->get_messageboard_details_by_id($messageboard_id);        echo json_encode($data);    }    function view_member_messages() {        $this->template->write_view('content', 'messageboard/view_member_messages');        $this->template->render();    }    function get_member_type() {        $data['member_type'] = $this->messageboard_model->get_all_member_type();        echo json_encode($data);    }    function get_members() {        $data['members'] = $this->messageboard_model->get_all_members();        echo json_encode($data);    }    function update_notification_status1() {        $message_received_status_id = $this->input->post("message_received_status_id");        $status = $this->input->post("status");        $messageboard_id = $this->input->post("messageboard_id");        $messageboard_details = $this->messageboard_model->get_messageboard_by_id($messageboard_id);        $created_by = $messageboard_details[0]['created_by'];        $response = array();        $date = date("Y-m-d H:i:s");        if ($status == "accepted") {            $data = array(                'acceptance_status' => "1",                'view_status' => "1",                'response_date' => $date            );            $update_message_received_status = $this->messageboard_model->update_message_received_status($data, $message_received_status_id);            if ($update_message_received_status) {                $response['status'] = "success";                $update_messageboard = $this->messageboard_model->increment_accept_count_messageboard($messageboard_id);            } else {                $response['status'] = "failed";            }        } else if ($status == "rejected") {            $response_message = $this->input->post("response_message");            $data = array(                'acceptance_status' => "2",                //'response_message' => $response_message,                'view_status' => "1",                'response_date' => $date            );            $update_message_received_status = $this->messageboard_model->update_message_received_status($data, $message_received_status_id);            if ($update_message_received_status) {                $this_member_id = $this->user_auth->get_user_id();                $response['status'] = "success";                $update_messageboard = $this->messageboard_model->increment_reject_count_messageboard($messageboard_id);                $data_chat_history = array(                    'message_id' => $messageboard_id,                    'receiver_id' => $created_by,                    'sender_id' => $this_member_id,                    'message' => $response_message,                );                $insert_chat = $this->messageboard_model->insert_chat_history($data_chat_history);            } else {                $response['status'] = "failed";            }        }        echo json_encode($response);    }    public function update_message_status() {        $message_received_status_id = $this->input->post("message_received_status_id");        $status = $this->input->post("status");        $messageboard_id = $this->input->post("messageboard_id");        $messageboard_details = $this->messageboard_model->get_messageboard_by_id($messageboard_id);        $created_by = $messageboard_details[0]['created_by'];        $response = array();        $date = date("Y-m-d H:i:s");        if ($status == "accepted") {            $data = array(                'acceptance_status' => "1",                'view_status' => "1",                'response_date' => $date            );            $update_message_received_status = $this->messageboard_model->update_message_received_status($data, $message_received_status_id);            if ($update_message_received_status) {                $response['status'] = "success";                $update_messageboard = $this->messageboard_model->increment_accept_count_messageboard($messageboard_id);            } else {                $response['status'] = "failed";            }        } else if ($status == "rejected") {            $response_message = $this->input->post("response_message");            $data = array(                'acceptance_status' => "2",                //'response_message' => $response_message,                'view_status' => "1",                'response_date' => $date            );            $update_message_received_status = $this->messageboard_model->update_message_received_status($data, $message_received_status_id);            if ($update_message_received_status) {                $this_member_id = $this->user_auth->get_user_id();                $response['status'] = "success";                $update_messageboard = $this->messageboard_model->increment_reject_count_messageboard($messageboard_id);                $data_chat_history = array(                    'message_id' => $messageboard_id,                    'receiver_id' => $created_by,                    'sender_id' => $this_member_id,                    'message' => $response_message,                );                $insert_chat = $this->messageboard_model->insert_chat_history($data_chat_history);            } else {                $response['status'] = "failed";            }        }        echo json_encode($response);    }    public function update_view_status() {        $message_received_status_id = $this->input->post("message_received_status_id");        $status = $this->input->post("status");        $messageboard_id = $this->input->post("messageboard_id");        $response = array();        $data = array(            'view_status' => "1"        );        $update_message_received_status = $this->messageboard_model->update_message_received_status($data, $message_received_status_id);        if ($update_message_received_status) {            $response['status'] = "success";        } else {            $response['status'] = "failed";        }        echo json_encode($response);    }    function update_notification_status() {        $chat_message_id = $this->input->post("chat_message_id");        $status = $this->input->post("status");        $messageboard_id = $this->input->post("messageboard_id");        $this_member = $this->user_auth->get_user_id();        $messageboard_details = $this->messageboard_model->get_messageboard_by_id($messageboard_id);        $created_by = $messageboard_details[0]['created_by'];        $response = array();        $date = date("Y-m-d H:i:s");        if ($status == "accepted") {            $data = array(                'message_id' => $messageboard_id,                'sender_id' => $this_member,                'receiver_id' => $created_by,                'acceptance_status' => "1",                'message' => "Invitation accepted",                'view_status' => "0",                'created_date' => $date            );            $update_message_received_status = $this->messageboard_model->insert_chat_messages($data);            $data_chat_message_status = array(                'view_status' => "1",                'acceptance_status' => "1"            );            $update_chat_message_status = $this->messageboard_model->update_chat_message($data_chat_message_status, $chat_message_id);            if ($update_message_received_status) {                $response['status'] = "success";                $update_messageboard = $this->messageboard_model->increment_accept_count_messageboard($messageboard_id);            } else {                $response['status'] = "failed";            }        } else if ($status == "rejected") {            $response_message = $this->input->post("response_message");            $data = array(                'message_id' => $messageboard_id,                'sender_id' => $this_member,                'receiver_id' => $created_by,                'acceptance_status' => "2",                'message' => $response_message,                'view_status' => "0",                'created_date' => $date,            );            $update_message_received_status = $this->messageboard_model->insert_chat_messages($data);            $data_chat_message_status = array(                'view_status' => "1",                'acceptance_status' => "2"            );            $update_chat_message_status = $this->messageboard_model->update_chat_message($data_chat_message_status, $chat_message_id);            if ($update_message_received_status) {                $this_member_id = $this->user_auth->get_user_id();                $response['status'] = "success";                $update_messageboard = $this->messageboard_model->increment_reject_count_messageboard($messageboard_id);            } else {                $response['status'] = "failed";            }        } else if ($status == "viewed") {            $data_chat_message_status = array(                'view_status' => "1",            );//            print_r($data_chat_message_status);//            print_r($chat_message_id);//            exit;            $update_chat_message_status = $this->messageboard_model->update_chat_message($data_chat_message_status, $chat_message_id);            //$update_messageboard = $this->messageboard_model->increment_accept_count_messageboard($messageboard_id);        } else {            $data_chat_message_status = array(                'view_status' => "1",            );            $update_chat_message_status = $this->messageboard_model->update_chat_message($data_chat_message_status, $chat_message_id);        }        echo json_encode($response);    }    function send_reply_message() {        $messageboard_id = $this->input->post("messageboard_id");        $created_by = $this->input->post("created_by");        $reply_message = $this->input->post("reply_message");        $this_member = $this->user_auth->get_user_id();        $response = array();        $response['member_count'] = 0;        $messageboard_details = $this->messageboard_model->get_messageboard_by_id($messageboard_id);        $created_date = date("Y-m-d H:i:s");        if ($this_member == $created_by) {            $receiver_type = $messageboard_details[0]['receiver_type'];            $member_type = $messageboard_details[0]['member_type_id'];            if ($receiver_type == "1") {                $all_member_id_by_type = $this->messageboard_model->get_all_members_by_type($member_type, $created_by);                if (is_array($all_member_id_by_type) && !empty($all_member_id_by_type)) {                    $response['member_count'] = count($all_member_id_by_type);                    foreach ($all_member_id_by_type as $member) {                        $data_chat_message = array(                            'message_id' => $messageboard_id,                            'sender_id' => $created_by,                            'receiver_id' => $member['id'],                            'message' => $reply_message,                            'acceptance_status' => 0,                            'view_status' => 0,                            'is_source_message' => 0,                            'created_date' => $created_date                        );                        $message_received_status = $this->messageboard_model->insert_chat_messages($data_chat_message);                    }                }            } else if ($receiver_type == "2") {                $member_id = $messageboard_details[0]['member_id'];                $memberdetails = $this->messageboard_model->get_user_by_id($member_id);                if (is_array($memberdetails) && !empty($memberdetails)) {                    $response['member_count'] = count($memberdetails);                    foreach ($memberdetails as $member) {                        $data_chat_message = array(                            'message_id' => $messageboard_id,                            'sender_id' => $created_by,                            'receiver_id' => $member['id'],                            'message' => $reply_message,                            'acceptance_status' => 0,                            'view_status' => 0,                            'is_source_message' => 0,                            'created_date' => $created_date                        );                        $message_received_status = $this->messageboard_model->insert_chat_messages($data_chat_message);                    }                }            } else if ($receiver_type == "3") {                $memberdetails = $this->messageboard_model->get_all_members($created_by);                if (is_array($memberdetails) && !empty($memberdetails)) {                    $response['member_count'] = count($memberdetails);                    foreach ($memberdetails as $member) {                        $data_chat_message = array(                            'message_id' => $messageboard_id,                            'sender_id' => $created_by,                            'receiver_id' => $member['id'],                            'message' => $reply_message,                            'acceptance_status' => 0,                            'view_status' => 0,                            'is_source_message' => 0,                            'created_date' => $created_date                        );                        $message_received_status = $this->messageboard_model->insert_chat_messages($data_chat_message);                    }                }            } else if ($receiver_type == "4") {                $memberdetails = $this->messageboard_model->get_user_by_admin_id();                if (is_array($memberdetails) && !empty($memberdetails)) {                    $response['member_count'] = count($memberdetails);                    foreach ($memberdetails as $member) {                        $data_chat_message = array(                            'message_id' => $messageboard_id,                            'sender_id' => $created_by,                            'receiver_id' => $member['id'],                            'message' => $reply_message,                            'acceptance_status' => 0,                            'view_status' => 0,                            'is_source_message' => 0,                            'created_date' => $created_date                        );                        $message_received_status = $this->messageboard_model->insert_chat_messages($data_chat_message);                    }                }            }        } else {            $memberdetails = $this->messageboard_model->get_user_by_id($created_by);            if (is_array($memberdetails) && !empty($memberdetails)) {                $response['member_count'] = count($memberdetails);                foreach ($memberdetails as $member) {                    $data_chat_message = array(                        'message_id' => $messageboard_id,                        'sender_id' => $this_member,                        'receiver_id' => $member['id'],                        'message' => $reply_message,                        'acceptance_status' => 0,                        'view_status' => 0,                        'is_source_message' => 0,                        'created_date' => $created_date                    );                    $message_received_status = $this->messageboard_model->insert_chat_messages($data_chat_message);                }            }        }        if ($response['member_count'] > 0) {            $response['result'] = "success";        } else {            $response['result'] = "failed";        }        echo json_encode($response);    }    function send_message_to_admin() {        $caption = $this->input->post("caption");        $message_content = $this->input->post("message_content");        $has_confirmation = "0";        $receiver_type = "4";        $created_by = $this->user_auth->get_user_id();        $created_date = date("Y-m-d H:i:s");        $member_type = 0;        $member_id = 0;        $data = array(            'caption' => $caption,            'message' => $message_content,            'member_type_id' => $member_type,            'member_id' => $member_id,            'receiver_type' => $receiver_type,            'has_confirmation' => $has_confirmation,            'created_by' => $created_by,            'created_date' => $created_date        );        $messageboard_id = $this->messageboard_model->insert($data);        $response = array();        if ($messageboard_id) {            $response['status'] = "success";            $memberdetails = $this->messageboard_model->get_user_by_admin_id($member_id);            if (is_array($memberdetails) && !empty($memberdetails)) {                $response['member_count'] = count($memberdetails);                foreach ($memberdetails as $member) {                    $data_chat_message = array(                        'message_id' => $messageboard_id,                        'sender_id' => $created_by,                        'receiver_id' => $member['id'],                        'acceptance_status' => 0,                        'view_status' => 0,                        'is_source_message' => 1,                        'created_date' => $created_date                    );                    $message_received_status = $this->messageboard_model->insert_chat_messages($data_chat_message);                }            } else {                $response['member_count'] = "0";            }            $update_total_count = array(                'total_count' => $response['member_count']            );            $update_message_total_count = $this->messageboard_model->update_messageboard($update_total_count, $messageboard_id);        } else {            $response['status'] = "failed";        }        echo json_encode($response);    }}